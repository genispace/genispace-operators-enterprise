name: Build and Deploy

on:
  push:
    branches:
      - main
      - latest
      - release/**
    tags:
      - 'v*.*.*'  # 版本tag，如 v1.0.0
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - prod

env:
  REGISTRY: magecommerce-docker.pkg.coding.net/genispace/images
  IMAGE_NAME: genispace-operators-enterprise
  DOCKER_BUILDKIT: 1
  CICD_REPO: genispace/cicd

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout genispace-operators-enterprise repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout cicd repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.CICD_REPO_TOKEN }}
          repository: ${{ env.CICD_REPO }}
          fetch-depth: 0
          path: cicd
        continue-on-error: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: magecommerce-docker.pkg.coding.net
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Get commit SHA and branch
        id: repo_info
        run: |
          COMMIT_SHA=$(git rev-parse HEAD)
          SHORT_SHA=${COMMIT_SHA:0:40}
          
          # 检查是否是tag触发
          REF="${{ github.ref }}"
          if [[ "$REF" == refs/tags/* ]]; then
            TAG=${REF#refs/tags/}
            echo "TAG=${TAG}" >> $GITHUB_OUTPUT
            echo "Tag: ${TAG}"
            # Tag触发时，尝试获取对应的分支（可能不存在）
            BRANCH=""
          else
            BRANCH=$(git rev-parse --abbrev-ref HEAD)
            echo "Branch: ${BRANCH}"
          fi
          
          echo "COMMIT_SHA=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "BRANCH=${BRANCH}" >> $GITHUB_OUTPUT
          echo "SHORT_SHA=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "Commit SHA: ${COMMIT_SHA}"

      - name: Determine environment and tag prefix
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
            UPDATE_CICD="true"
          else
            BRANCH="${{ steps.repo_info.outputs.BRANCH }}"
            TAG="${{ steps.repo_info.outputs.TAG }}"
            
            # Tag触发或release分支：使用prod环境，但不更新cicd仓库
            if [ -n "$TAG" ] && [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
              # Tag默认使用prod环境
              ENV="prod"
              UPDATE_CICD="false"
            elif [[ "$BRANCH" == release/* ]]; then
              ENV="prod"
              UPDATE_CICD="false"
            elif [ "$BRANCH" == "main" ]; then
              ENV="prod"
              UPDATE_CICD="true"
            elif [ "$BRANCH" == "latest" ]; then
              ENV="test"
              UPDATE_CICD="true"
            else
              echo "Unsupported branch: $BRANCH"
              exit 1
            fi
          fi
          
          if [ "$ENV" == "prod" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            if [ -n "$TAG" ]; then
              echo "tag_prefix=${TAG}" >> $GITHUB_OUTPUT
            else
              echo "tag_prefix=main" >> $GITHUB_OUTPUT
            fi
            echo "kustomization_paths=apps/genispace/overlays/cn/prod/kustomization.yaml apps/genispace/overlays/global/prod/kustomization.yaml" >> $GITHUB_OUTPUT
          elif [ "$ENV" == "test" ]; then
            echo "environment=test" >> $GITHUB_OUTPUT
            echo "tag_prefix=latest" >> $GITHUB_OUTPUT
            echo "kustomization_paths=apps/genispace/overlays/cn/test/kustomization.yaml apps/genispace/overlays/global/test/kustomization.yaml" >> $GITHUB_OUTPUT
          fi
          
          echo "update_cicd=${UPDATE_CICD}" >> $GITHUB_OUTPUT
          
          echo "Environment: $ENV"
          echo "Tag prefix: $(cat $GITHUB_OUTPUT | grep tag_prefix | cut -d'=' -f2)"
          echo "Update CICD: ${UPDATE_CICD}"

      - name: Build and push Docker image
        env:
          COMMIT_SHA: ${{ steps.repo_info.outputs.COMMIT_SHA }}
          SHORT_SHA: ${{ steps.repo_info.outputs.SHORT_SHA }}
        run: |
          TAG_PREFIX="${{ steps.env.outputs.tag_prefix }}"
          IMAGE_TAG="${TAG_PREFIX}-${SHORT_SHA}"
          FULL_IMAGE_NAME="${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}"
          
          echo "Building ${FULL_IMAGE_NAME}..."
          
          # 构建镜像
          docker build \
            -f Dockerfile \
            -t "${FULL_IMAGE_NAME}" \
            .
          
          # 推送镜像
          echo "Pushing ${FULL_IMAGE_NAME}..."
          docker push "${FULL_IMAGE_NAME}"
          
          # 同时推送 latest/main 标签（仅非tag触发时）
          if [ -z "${{ steps.repo_info.outputs.TAG }}" ]; then
            if [ "$TAG_PREFIX" == "main" ]; then
              docker tag "${FULL_IMAGE_NAME}" "${REGISTRY}/${IMAGE_NAME}:main"
              docker push "${REGISTRY}/${IMAGE_NAME}:main"
            elif [ "$TAG_PREFIX" == "latest" ]; then
              docker tag "${FULL_IMAGE_NAME}" "${REGISTRY}/${IMAGE_NAME}:latest"
              docker push "${REGISTRY}/${IMAGE_NAME}:latest"
            fi
          fi
          
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Update Kustomization
        if: steps.env.outputs.update_cicd == 'true'
        run: |
          cd cicd
          
          # 获取当前分支名
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "Current branch: ${CURRENT_BRANCH}"
          
          # 先拉取远程最新更改，确保代码仓库是最新的
          git fetch origin
          git pull --rebase origin "${CURRENT_BRANCH}" || git pull --rebase origin HEAD
          
          cd ..
          
          KUSTOMIZATION_PATHS="${{ steps.env.outputs.kustomization_paths }}"
          IMAGE_TAG="${{ env.IMAGE_TAG }}"
          IMAGE_NAME_FULL="${REGISTRY}/${IMAGE_NAME}"
          
          # 更新所有环境的 kustomization.yaml
          for KUSTOMIZATION_PATH in ${KUSTOMIZATION_PATHS}; do
            FULL_PATH="cicd/${KUSTOMIZATION_PATH}"
            echo "Updating ${FULL_PATH} with tag ${IMAGE_TAG}"
            
            # 使用 yq 更新镜像标签
            yq eval ".images[] |= select(.name == \"${IMAGE_NAME_FULL}\") |= .newTag = \"${IMAGE_TAG}\"" -i "${FULL_PATH}"
            
            # 验证更新是否成功
            echo "Updated ${KUSTOMIZATION_PATH}:"
            yq eval '.images[] | select(.name == "'"${IMAGE_NAME_FULL}"'")' "${FULL_PATH}"
          done

      - name: Commit and push changes to cicd repository
        if: steps.env.outputs.update_cicd == 'true'
        run: |
          cd cicd
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          KUSTOMIZATION_PATHS="${{ steps.env.outputs.kustomization_paths }}"
          ENVIRONMENT="${{ steps.env.outputs.environment }}"
          IMAGE_TAG="${{ env.IMAGE_TAG }}"
          
          # 获取当前分支名
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "Current branch: ${CURRENT_BRANCH}"
          
          # 添加所有更新的文件
          for KUSTOMIZATION_PATH in ${KUSTOMIZATION_PATHS}; do
            git add "${KUSTOMIZATION_PATH}"
          done
          
          # 检查是否有更改
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            # 生成提交信息，列出所有更新的环境
            ENV_LIST=$(echo "${KUSTOMIZATION_PATHS}" | sed 's|apps/genispace/overlays/||g' | sed 's|/kustomization.yaml||g' | tr ' ' ',')
            git commit -m "chore(${{ env.IMAGE_NAME }}): update image tag to ${IMAGE_TAG} for ${ENVIRONMENT} environment (${ENV_LIST}) [skip ci]"
            git push origin "${CURRENT_BRANCH}"
            echo "Successfully pushed changes to ${ENVIRONMENT} environment (${ENV_LIST})"
          fi

      - name: Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: ${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ steps.env.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ steps.repo_info.outputs.BRANCH }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.repo_info.outputs.TAG }}" ]; then
            echo "- **Tag**: ${{ steps.repo_info.outputs.TAG }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Commit SHA**: ${{ steps.repo_info.outputs.COMMIT_SHA }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag**: ${{ env.IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${REGISTRY}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.env.outputs.update_cicd }}" == "true" ]; then
            echo "- **CICD Update**: ✅ Updated" >> $GITHUB_STEP_SUMMARY
            echo "- **Kustomization Paths**: " >> $GITHUB_STEP_SUMMARY
            KUSTOMIZATION_PATHS="${{ steps.env.outputs.kustomization_paths }}"
            for path in ${KUSTOMIZATION_PATHS}; do
              echo "  - cicd/${path}" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "- **CICD Update**: ⏭️ Skipped (release branch or tag)" >> $GITHUB_STEP_SUMMARY
          fi
